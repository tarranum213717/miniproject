/**
  ******************************************************************************
  * @file    p2p_demo.c (-> app_x-cube-subg2.c)
  * @author  SRA Application Team
  * @brief   P2P demo applicative code.
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2023 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
#ifdef __cplusplus
 extern "C" {
#endif

/* Includes ------------------------------------------------------------------*/

#include "main.h"

#include "app_x-cube-subg2.h"
#include "stm32f4xx_nucleo.h"
#include "s2868a2.h"
#include "s2lp.h"
#include "p2p_demo_settings.h"

#include "S2LP_PktBasic.h"
#include "s2lp_sdkapi_mapping.h"
#include "s2lp_management.h"
#include  "string.h"
#include "stdio.h"
/** @defgroup S2LP_Nucleo
  * @{
  */

/** @defgroup Main
  * @{
  */

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
#define TX_BUFFER_SIZE   44
#define RX_BUFFER_SIZE   120

#define MAX_PACKET_SIZE  128
#define MAX_PAYLOAD_SIZE   44
#define Length           4096
/Source address of one node should be destination for other node & vice-versa/

#define MY_ADDRESS                  0x44  //0x44
#define DESTINATION_ADDRESS         0x44  //0x34
#define CRC16_POLYNOMIAL            0x1021

#if defined (USE_LOW_POWER_MODE)
//#define MCU_SLEEP_MODE
#define MCU_STOP_MODE
#endif

/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
uint32_t TxLength = Length;
uint8_t RxLength = 0;
//uint8_t aTransmitBuffer[Length] = {90,92,96,99,101,101,100,99,107,107,108,109,110,111,112,112,104,109,111,107,105,107,108,106,108,107,105,105,105,104,102,100,101,107,108,103,103,108,108,102,106,98,93,95,98,96,92,90,86,85,84,82,79,77,76,75,71,70,69,67,65,64,62,61,92,94,97,99,101,102,102,101,107,108,108,110,111,112,112,113,115,117,116,111,109,112,112,110,115,112,109,109,112,113,111,109,113,108,106,110,114,113,110,108,101,102,105,105,99,91,89,92,88,88,86,84,81,79,78,77,73,72,71,69,67,66,64,63,95,96,98,100,102,103,104,105,109,109,110,111,112,113,114,114,118,117,114,111,111,114,114,112,102,110,116,114,106,103,109,115,112,105,105,112,113,107,105,110,115,109,104,104,103,101,100,102,91,90,89,86,84,82,80,79,76,75,74,72,70,68,67,66,98,99,99,101,103,105,108,109,110,111,111,112,113,114,115,116,116,114,112,112,114,116,115,113,125,116,110,112,120,121,113,104,114,114,116,117,115,111,112,116,111,107,103,104,103,100,99,101,94,93,91,88,86,83,81,80,77,77,75,74,72,70,69,68,100,100,100,102,104,107,110,112,112,112,113,114,115,116,117,117,118,117,117,118,119,118,117,116,113,115,115,112,110,113,121,128,116,118,114,109,115,124,119,106,107,111,116,118,112,103,100,103,95,94,92,90,87,84,82,81,79,78,77,75,73,71,70,69,100,101,101,103,105,108,111,113,113,114,115,116,117,118,119,119,120,119,120,121,120,116,116,119,117,126,132,128,121,126,146,165,176,172,160,155,171,188,175,148,135,119,105,104,110,112,108,105,98,96,94,91,88,86,83,82,81,80,78,77,75,73,72,71,100,100,102,104,106,109,112,113,115,115,116,117,118,119,120,120,120,120,121,122,119,117,123,131,123,123,137,172,216,249,255,255,255,254,247,244,253,255,254,238,191,164,133,116,110,107,103,101,100,99,97,94,91,88,86,84,83,82,81,79,77,75,74,73,99,100,102,104,107,110,112,113,115,116,117,118,119,120,120,121,122,122,124,125,123,124,136,150,194,216,243,255,253,247,247,251,251,255,255,255,252,248,252,255,252,251,236,198,146,110,105,116,103,101,99,96,93,90,88,86,85,84,83,81,79,77,76,75,102,103,105,107,109,111,113,114,118,109,110,123,127,119,116,122,127,121,127,132,124,138,191,241,253,255,255,255,254,253,255,255,255,255,255,255,254,253,254,255,255,255,251,255,230,195,192,169,136,106,101,95,99,100,83,90,84,87,84,82,82,74,72,82,102,102,104,106,108,110,112,113,110,121,123,115,116,128,132,127,124,122,128,149,184,222,249,255,253,254,255,255,255,254,254,253,253,255,255,255,254,254,255,255,247,251,254,255,255,251,255,246,219,169,134,108,98,92,80,93,85,86,83,82,85,80,74,76,100,101,103,105,107,109,111,112,117,114,115,120,121,119,122,129,161,206,239,244,247,252,254,255,253,253,254,255,255,255,253,251,255,255,255,255,253,253,254,255,255,255,255,248,251,255,252,255,250,251,225,155,109,106,95,84,83,82,80,79,82,83,80,76,100,101,102,104,107,109,110,111,120,113,114,123,122,122,145,177,236,255,255,255,255,255,252,254,254,252,251,252,253,254,253,252,255,255,255,253,250,249,250,252,255,255,255,245,251,255,239,255,253,255,255,241,192,134,97,91,88,86,86,84,79,81,83,79,101,101,103,105,107,109,111,112,112,122,125,121,136,176,223,250,255,250,243,247,254,251,250,255,253,251,248,247,248,249,251,251,250,250,249,247,245,245,246,248,249,248,255,251,254,245,218,235,253,249,249,255,255,211,147,96,91,87,93,94,81,79,83,80,102,103,105,107,109,111,113,113,117,112,119,153,202,242,255,255,252,255,255,255,227,213,231,248,249,249,246,243,240,240,242,244,240,240,239,237,236,237,240,242,246,247,254,252,245,220,184,173,245,255,255,237,252,255,227,143,100,81,84,94,84,82,87,83,104,105,107,109,111,113,115,116,123,120,151,212,255,255,249,243,255,250,241,199,157,184,232,239,243,246,246,241,233,228,228,230,233,232,230,227,225,225,227,229,230,240,246,252,249,233,199,149,226,253,253,251,249,248,251,229,161,107,84,91,87,87,92,85,106,107,108,110,113,115,116,117,111,164,225,254,254,249,252,255,247,252,242,174,117,167,233,227,239,244,247,241,229,220,218,219,232,230,227,222,217,215,215,217,216,235,237,247,250,246,216,137,176,236,255,251,234,237,255,250,245,158,102,96,90,90,93,82,111,111,111,108,121,122,112,131,177,228,250,255,247,242,255,242,241,235,224,145,113,178,216,234,233,237,231,216,207,208,209,205,220,230,224,215,210,194,189,206,203,212,222,239,243,239,210,147,139,225,247,251,245,229,249,255,248,237,156,95,92,94,89,92,111,116,120,112,115,121,141,191,235,255,254,245,236,234,246,232,225,221,207,127,116,178,211,223,231,226,218,212,204,196,190,189,199,213,214,211,206,189,178,189,196,200,203,216,226,234,215,156,111,191,247,251,244,234,231,245,255,255,207,126,102,96,91,92,114,119,124,117,117,129,170,244,255,255,247,237,234,235,236,219,229,224,196,109,128,182,211,215,220,207,199,201,199,189,183,186,182,194,199,198,194,179,170,176,191,198,200,206,211,226,221,174,105,169,244,241,227,225,210,232,242,247,230,131,100,98,96,92,120,117,121,121,128,138,178,252,242,240,229,224,225,229,226,215,238,230,186,96,141,190,216,217,206,197,190,189,187,183,183,186,179,184,185,181,176,170,169,174,178,193,203,207,203,214,218,181,102,153,228,235,215,207,196,211,216,218,222,116,94,104,106,93,123,118,121,125,132,138,170,240,225,219,213,206,204,210,214,219,231,221,170,93,151,194,215,212,197,200,197,186,179,179,177,174,175,174,174,170,163,163,166,166,155,168,182,199,204,214,215,179,92,133,204,241,221,195,188,184,199,208,219,119,99,109,110,97,124,123,129,128,129,130,161,230,201,196,203,199,197,201,203,219,225,214,161,104,155,189,203,198,197,205,203,189,179,179,176,170,162,162,169,168,159,157,155,145,137,134,146,183,210,227,226,188,119,129,189,241,223,190,181,172,171,196,206,127,106,106,106,102,127,128,134,130,130,131,153,211,187,176,186,188,191,198,198,218,224,209,152,114,152,185,200,201,211,204,191,176,166,164,165,166,151,152,165,168,156,151,143,123,115,101,108,154,190,212,222,199,150,119,182,236,221,193,168,166,152,181,169,119,110,107,103,107,132,130,132,131,138,138,146,188,199,172,169,164,172,189,196,222,214,195,135,112,143,186,211,220,230,203,173,153,141,135,141,151,148,148,163,167,153,147,137,113,89,73,80,122,151,174,200,196,145,91,176,235,226,204,152,154,161,180,141,109,116,115,107,109,130,132,135,134,134,137,145,151,188,180,155,156,167,174,199,219,218,195,111,108,162,189,218,228,196,184,141,103,102,112,122,138,144,155,169,175,169,154,137,124,74,35,17,15,66,118,165,163,130,86,131,211,250,194,162,149,176,149,123,115,116,114,111,112,132,134,137,137,137,139,143,146,168,183,166,150,151,172,209,225,217,177,97,108,168,192,203,189,182,145,94,61,55,68,103,142,152,167,182,187,183,172,154,140,59,20,16,3,10,59,139,155,122,77,116,180,233,218,165,158,158,137,119,116,118,115,112,112,135,137,138,140,141,141,141,141,146,173,174,162,154,169,206,220,212,158,90,107,155,173,175,148,107,57,21,16,16,35,91,146,166,184,199,202,200,194,180,163,133,48,18,22,47,109,167,148,127,84,116,162,212,245,178,163,137,125,118,120,122,118,115,115,138,138,138,140,142,143,142,141,144,157,164,174,170,174,205,221,193,143,98,112,135,151,166,151,71,18,0,9,18,46,110,163,191,208,220,220,220,221,211,197,191,117,80,84,105,149,180,160,138,105,134,174,185,243,194,152,128,123,121,124,125,121,118,119,140,139,138,140,142,145,146,145,152,150,151,167,173,186,211,209,167,129,108,121,132,153,179,177,130,79,48,48,58,96,157,197,222,234,242,239,240,244,241,232,221,191,154,140,144,155,160,163,136,119,156,200,158,213,202,135,129,127,126,126,124,121,119,120,142,142,142,143,145,147,150,151,147,152,154,161,167,188,198,163,160,130,117,125,137,161,180,176,173,141,113,106,121,159,203,227,241,246,249,248,248,251,251,249,245,235,193,173,172,175,160,164,132,128,179,219,145,181,195,135,132,130,128,125,122,119,118,118,143,146,150,151,150,150,152,154,149,156,161,164,161,180,193,157,172,150,135,128,138,161,171,169,165,159,148,148,171,199,223,240,247,245,247,249,248,245,246,250,236,244,223,200,168,173,170,175,138,139,200,218,143,160,164,141,134,132,129,125,123,122,119,117,144,150,156,157,155,152,153,155,168,158,156,163,156,175,214,210,183,169,152,133,138,163,175,180,165,171,163,165,189,208,222,243,250,245,246,252,250,243,243,249,250,246,233,216,175,188,184,165,147,147,212,205,141,147,129,142,134,133,130,127,126,125,122,119,151,153,156,157,158,159,160,161,164,156,166,166,156,182,229,250,200,177,158,157,162,165,173,184,182,174,180,187,191,215,236,232,231,234,224,211,190,178,200,219,226,233,237,207,185,193,188,175,146,183,217,199,154,141,145,136,137,133,129,127,127,126,123,121,153,156,158,160,160,161,163,164,161,173,166,154,174,216,242,248,204,185,169,164,161,160,171,186,197,185,185,188,193,213,228,221,207,167,127,109,108,115,127,142,194,227,248,231,195,180,182,177,163,203,228,202,158,143,146,141,137,133,129,127,127,126,124,122,154,156,159,161,162,163,164,166,163,176,160,159,208,246,250,252,212,191,172,167,164,163,171,184,200,189,187,193,202,219,226,218,189,137,107,86,86,97,103,133,127,188,226,239,214,187,196,190,182,222,233,196,159,145,143,144,138,133,128,126,126,126,125,124,153,155,158,160,161,162,163,165,169,162,161,194,240,253,249,255,222,194,168,163,166,167,172,179,189,187,190,199,209,216,214,205,149,91,69,39,23,22,16,56,97,168,202,232,228,202,202,176,192,225,219,180,157,147,141,143,137,133,127,125,126,127,127,126,151,154,157,159,160,161,163,165,169,158,187,236,254,252,253,252,224,199,174,165,161,158,164,175,182,189,197,207,211,202,187,178,155,74,31,0,0,3,0,19,81,154,184,216,231,218,213,179,199,215,199,167,158,153,144,143,135,131,126,125,127,129,130,129,151,153,156,159,160,161,164,165,166,181,227,255,252,255,255,241,221,205,188,173,154,141,150,168,175,188,199,210,214,196,172,165,143,67,17,0,1,8,0,19,62,132,169,199,222,218,215,200,207,203,183,165,160,157,149,144,132,129,125,125,128,131,132,132,148,151,154,157,158,160,162,163,169,215,254,255,250,255,255,236,220,206,190,177,158,140,141,153,165,177,185,198,209,192,166,160,126,73,25,5,0,0,0,3,66,119,160,190,212,204,194,205,213,192,175,167,158,151,146,139,129,126,124,126,130,133,134,133,145,148,151,153,155,156,159,160,177,236,255,250,254,254,243,239,223,201,181,175,168,152,140,138,158,166,167,179,195,180,153,148,120,73,19,5,4,0,10,17,59,95,142,185,219,213,199,228,215,184,171,169,153,142,140,133,126,125,124,127,131,135,135,134,147,139,146,158,155,150,155,162,207,240,255,255,248,249,240,221,207,198,186,177,168,156,141,130,133,162,146,137,178,188,153,135,98,63,27,11,5,5,14,27,58,79,130,185,210,212,229,255,235,197,167,156,147,139,135,130,127,126,126,129,134,137,138,138,143,141,140,145,148,150,157,167,224,249,255,255,246,243,236,223,220,202,181,170,169,164,152,140,135,134,145,151,152,161,149,113,93,65,39,28,21,16,19,29,39,75,127,172,201,222,243,255,244,203,169,153,140,131,127,122,124,124,125,129,134,138,139,138,138,145,140,139,149,150,155,174,239,251,255,249,238,231,226,221,216,205,186,164,147,140,141,144,128,115,132,146,135,140,143,120,87,59,29,13,8,13,32,52,77,116,151,168,192,228,251,253,251,206,167,147,131,122,119,115,121,122,125,129,134,137,138,137,136,148,145,147,157,147,152,187,247,249,250,245,234,222,218,219,204,197,180,156,134,125,130,138,125,118,113,119,127,122,123,135,114,101,90,86,81,78,87,100,132,156,165,160,181,225,250,248,249,203,161,139,123,116,116,114,120,121,125,128,132,133,133,133,137,146,146,153,158,144,160,214,255,251,249,246,234,220,213,215,202,185,165,154,151,149,141,134,131,118,103,103,107,100,101,115,144,131,116,107,102,106,123,141,139,147,146,146,171,215,242,245,243,197,154,133,118,112,114,113,120,122,124,126,127,126,126,125,141,143,143,149,151,149,184,245,255,251,247,242,230,214,205,203,198,186,172,164,161,155,145,136,130,104,107,111,92,93,102,88,100,107,119,129,129,123,121,124,137,140,143,152,175,206,227,234,237,191,150,130,116,110,111,111,119,120,122,122,120,118,118,118,145,146,147,146,147,165,212,255,250,246,241,234,224,211,202,197,190,187,179,168,155,145,139,138,112,106,111,109,97,101,103,87,84,85,90,96,101,107,117,126,140,149,161,171,186,204,220,228,227,184,146,129,117,111,112,110,116,118,118,117,114,112,113,114,147,151,155,150,150,182,229,255,248,245,240,232,224,216,207,201,189,178,165,158,157,153,144,135,96,127,111,90,107,103,85,96,96,96,98,102,105,110,119,126,130,148,167,177,188,207,227,239,219,177,143,129,119,114,115,113,114,115,116,114,111,109,111,113,150,159,151,155,163,221,249,254,248,239,229,224,221,211,194,180,171,167,160,155,155,153,143,129,122,121,110,95,89,94,98,98,97,93,93,98,103,108,118,128,138,140,149,165,183,201,222,238,218,174,149,132,123,122,112,110,113,113,112,111,108,107,106,107,147,156,158,157,189,235,255,252,249,241,230,220,211,203,194,187,176,163,155,157,158,152,141,135,124,117,108,98,90,89,95,104,96,91,89,92,96,102,113,124,136,143,155,168,180,195,218,237,207,155,135,128,120,122,118,115,111,111,110,108,107,106,106,107,140,146,158,160,216,244,255,241,232,236,238,234,221,204,189,181,176,156,144,149,152,144,139,143,129,119,110,105,97,90,96,109,103,99,95,95,98,105,116,126,136,146,161,171,177,191,217,241,217,150,134,135,120,120,119,113,109,108,107,106,105,106,107,107,139,138,150,177,235,250,246,234,239,234,224,211,198,191,189,189,177,160,146,142,138,132,133,140,133,126,118,112,107,104,106,110,110,108,105,104,106,112,121,128,129,139,152,162,169,186,217,243,233,154,138,143,122,118,119,109,108,107,105,105,106,107,108,108,145,137,148,208,247,255,239,240,231,222,207,193,183,175,170,167,166,164,157,144,132,126,125,124,125,127,122,113,114,121,119,110,110,110,110,109,109,114,119,122,120,125,135,146,160,182,214,239,232,152,136,143,122,118,120,113,108,106,104,105,107,109,109,109,146,135,158,232,249,252,236,239,212,208,202,196,187,170,150,135,133,144,149,142,133,128,122,116,112,120,119,109,113,126,125,111,109,112,112,110,111,114,118,118,120,122,130,143,160,183,213,236,233,160,140,141,123,118,116,113,107,105,104,106,109,110,109,107,145,136,181,242,245,238,234,223,216,206,191,179,170,162,153,146,123,126,132,136,134,127,121,119,109,116,116,108,107,115,118,114,109,112,112,108,108,113,117,117,124,128,137,149,163,181,206,226,231,169,144,135,120,113,106,108,105,103,103,106,109,110,107,103,148,142,206,246,244,227,235,207,198,193,186,178,171,161,152,145,146,133,129,135,135,124,118,121,114,117,117,110,102,100,107,115,107,109,107,102,102,108,114,114,122,129,140,151,160,173,194,213,218,165,137,124,114,107,99,104,103,102,102,105,109,109,105,100,133,178,225,232,232,227,206,203,196,188,177,168,161,156,151,147,138,129,124,118,112,118,122,115,112,117,118,111,107,109,111,112,108,105,106,111,114,115,115,118,121,129,134,141,150,158,179,208,205,143,124,108,104,91,94,95,98,101,103,103,106,109,108,103,148,190,231,231,226,219,198,194,188,178,165,154,148,145,143,141,132,122,113,105,99,106,113,108,109,114,114,108,103,105,108,108,109,106,106,111,114,114,115,117,114,121,124,130,141,151,176,207,209,146,125,108,102,89,92,94,98,101,103,103,106,109,108,103};
uint8_t aTransmitBuffer[Length]={180,213,151,29,183,193,164,108,159,30,15,192,137,220,147,230,70,80,113,202,172,75,71,169,38,11,103,136,192,49,161,244,26,20,12,39,184,121,229,145,33,221,88,120,89,230,242,66,165,98,150,8,52,184,140,2,142,39,158,255,195,109,42,99,192,151,162,45,144,174,91,196,97,6,108,48,175,206,136,111,59,111,202,247,64,8,245,115,251,58,101,182,196,57,251,112,57,221,106,214,85,125,156,72,113,209,240,130,140,143,233,247,64,113,212,105,31,103,125,80,247,190,70,212,179,127,166,71,212,188,225,182,152,163,182,175,160,151,254,157,220,136,253,210,25,108,108,92,250,235,0,123,87,162,129,76,188,165,238,20,73,58,180,197,166,241,145,164,135,58,47,143,144,90,198,54,31,135,112,164,38,7,40,197,104,175,170,235,107,181,237,216,19,174,101,149,69,92,225,74,200,243,140,104,117,67,57,126,96,186,187,160,53,54,250,146,1,39,188,220,137,149,102,111,140,145,98,70,113,224,52,90,145,155,95,39,251,205,237,44,54,114,79,56,12,254,253,100,211,188,15,45,111,194,83,121,224,153,36,69,252,19,147,154,230,188,203,17,128,166,17,34,98,40,35,26,68,3,78,63,16,112,155,101,79,62,31,78,63,72,77,130,89,237,223,165,85,86,213,151,0,2,2,96,149,171,46,250,140,190,152,199,124,92,188,190,234,48,254,175,97,163,192,123,222,242,82,98,9,51,195,94,223,203,132,53,138,230,168,79,136,182,166,200,95,173,171,209,26,99,235,58,184,223,38,136,33,19,79,227,25,127,217,241,52,194,140,50,204,5,61,13,159,87,146,116,198,41,217,216,160,215,190,175,69,164,59,144,128,96,70,111,20,113,70,138,163,103,163,88,179,255,209,241,160,204,182,103,74,120,34,140,250,196,11,255,28,68,5,46,88,117,165,158,142,37,89,181,177,207,105,80,187,201,96,151,132,253,225,149,165,22,124,5,64,58,69,43,77,140,143,247,253,85,98,157,127,83,211,117,232,107,145,195,68,217,114,30,189,242,4,16,23,72,70,201,173,55,225,134,103,110,37,243,45,163,125,48,158,210,226,177,88,82,112,65,140,220,164,116,61,74,151,197,242,209,61,211,109,139,165,17,58,130,223,214,28,171,180,136,100,57,162,239,198,241,194,59,221,227,227,42,71,1,179,40,143,119,214,82,108,217,125,89,92,48,234,170,208,98,109,220,236,229,254,140,79,156,73,75,47,169,235,17,205,126,250,54,144,140,71,159,88,247,14,151,224,37,245,184,201,228,215,206,40,143,76,249,108,234,64,235,94,219,14,127,97,196,100,151,23,173,57,222,218,17,132,28,171,28,150,98,145,84,140,182,32,24,47,208,75,60,58,150,96,213,35,221,104,109,67,140,160,11,90,72,52,138,101,218,158,218,224,193,246,220,176,13,241,106,25,228,178,33,115,44,160,57,13,31,74,42,25,141,135,244,50,79,126,165,22,158,39,36,23,156,33,238,82,253,100,250,40,180,87,208,104,237,206,71,161,233,114,16,234,95,70,228,78,240,126,60,250,136,173,60,154,245,54,228,208,225,158,174,140,171,255,100,187,177,151,196,250,190,79,254,77,7,94,232,32,51,111,73,38,25,137,2,117,227,151,17,132,250,8,221,245,201,223,126,254,217,84,202,61,9,34,119,59,123,155,53,115,48,34,157,177,32,248,193,16,147,140,114,159,133,168,54,166,206,16,89,26,32,154,194,130,147,72,64,66,205,65,113,19,217,105,121,48,173,229,197,120,74,160,157,214,37,248,92,163,145,159,30,215,210,239,29,80,207,183,210,159,191,209,19,151,17,96,5,116,151,236,191,27,191,135,203,247,158,185,173,94,184,24,20,43,146,13,191,8,5,47,160,164,2,140,222,246,136,102,66,190,174,84,208,2,119,125,20,161,182,111,92,234,159,246,205,148,236,182,62,102,176,51,37,12,243,177,161,231,217,222,62,103,169,232,209,42,118,48,61,172,169,156,220,125,156,136,58,227,156,21,243,84,232,116,58,144,255,43,24,143,176,45,7,94,220,137,24,232,93,73,92,29,82,24,106,251,152,2,162,248,51,114,233,221,180,226,141,33,194,234,118,111,188,93,82,205,240,87,35,167,28,239,203,138,62,246,152,44,189,76,29,118,249,250,44,233,249,58,137,215,221,188,98,115,175,217,44,74,10,177,52,22,216,209,169,201,231,10,49,139,184,215,202,202,101,244,202,137,212,200,200,6,210,149,95,204,85,111,22,37,194,233,147,182,198,98,199,30,191,238,240,216,199,41,10,131,180,171,103,110,38,237,77,192,222,164,169,170,137,67,61,6,162,228,91,69,138,172,156,202,185,166,84,157,30,39,192,92,206,71,43,164,242,89,195,163,71,12,176,248,200,208,88,142,2,6,189,23,21,43,55,228,102,98,224,75,107,107,213,105,5,233,217,198,81,98,11,158,178,107,225,0,217,69,185,13,15,161,129,176,186,47,163,147,159,74,85,254,195,79,31,219,53,72,171,203,61,217,100,110,48,215,179,253,44,146,232,105,77,152,103,238,77,182,139,51,40,121,136,234,198,252,163,116,222,142,108,233,20,90,180,70,50,250,130,114,142,189,96,73,150,66,134,20,213,7,11,110,220,82,10,194,174,16,81,176,184,161,136,163,193,80,106,128,22,52,163,71,29,224,205,23,150,102,197,67,183,208,157,92,55,228,238,189,103,193,49,167,15,81,180,104,234,165,40,188,120,62,95,136,228,143,170,79,33,159,184,161,119,40,226,43,44,183,24,130,41,18,21,204,85,253,208,186,176,164,244,130,18,156,244,107,68,10,100,158,156,127,149,1,120,155,54,34,166,44,17,205,92,133,29,200,20,84,59,190,134,158,207,76,249,119,178,176,97,203,124,231,57,157,129,150,48,86,139,90,85,52,195,133,8,194,24,234,115,56,72,79,191,184,255,127,153,223,84,145,181,159,76,240,58,182,252,32,176,166,224,205,89,10,86,191,155,223,3,205,200,97,83,50,131,49,179,43,14,254,10,62,220,88,193,127,21,103,251,218,247,181,165,144,199,244,111,17,130,232,188,83,23,114,251,137,32,184,16,83,152,162,26,151,28,103,73,66,69,68,32,151,138,28,238,40,142,191,196,226,160,75,206,168,93,33,132,83,196,247,217,51,216,211,144,116,87,136,199,193,29,130,66,0,221,141,152,192,11,30,232,12,108,225,126,53,29,244,151,136,74,249,33,170,17,71,253,58,208,248,71,35,235,73,81,70,150,233,71,245,103,118,118,75,248,97,32,126,45,186,0,188,168,12,246,61,148,9,238,111,193,177,115,93,151,86,243,248,241,49,102,192,0,209,72,227,116,116,111,71,54,33,27,122,13,195,152,4,16,9,166,96,52,164,207,167,167,193,166,214,85,232,92,29,1,205,221,127,30,33,172,134,215,218,81,118,67,18,1,215,14,26,176,147,80,9,101,110,138,249,75,100,235,224,241,9,193,44,57,30,136,178,56,137,113,129,188,207,227,210,22,110,33,156,95,102,14,192,173,220,95,248,236,58,190,229,196,163,226,48,215,226,55,205,243,135,50,81,126,92,137,133,118,148,46,219,188,170,40,120,51,133,196,98,204,96,90,124,102,228,131,25,131,161,59,37,144,121,31,142,12,62,171,190,45,67,237,115,60,128,26,116,232,31,82,231,115,65,99,125,173,183,28,63,1,72,213,88,93,220,181,183,182,9,64,210,91,143,114,31,21,49,81,5,183,252,55,1,62,138,232,247,23,60,128,47,98,23,146,18,98,10,241,176,234,53,231,144,69,25,199,80,185,11,169,117,162,21,152,34,13,16,89,15,19,244,29,216,219,81,123,56,44,233,69,29,60,94,254,12,132,154,71,65,42,42,117,144,87,25,44,135,105,39,149,64,108,69,113,112,188,17,24,196,187,1,217,41,237,148,255,162,255,121,27,37,186,146,3,18,92,48,111,2,20,82,179,136,236,46,9,35,147,110,139,190,110,224,210,11,209,173,137,39,232,63,114,83,86,173,77,236,225,126,138,54,174,75,228,159,37,25,72,247,216,219,32,233,127,159,74,47,250,242,45,34,72,50,205,214,1,135,52,43,157,103,164,70,73,66,27,110,244,46,51,204,155,50,102,217,176,230,210,117,230,6,253,196,175,231,40,130,70,201,102,136,107,103,108,61,202,71,144,151,92,122,73,66,5,89,201,190,225,237,34,255,43,201,38,248,186,83,49,222,60,17,206,168,90,24,148,147,139,23,241,108,21,177,8,181,165,216,56,194,230,75,198,91,81,101,159,122,148,105,19,165,147,140,148,63,94,85,0,161,156,191,179,246,210,105,249,12,212,138,134,145,28,2,24,182,244,2,213,52,108,136,186,27,167,50,182,164,213,218,192,144,30,88,9,239,106,102,134,147,220,74,7,173,239,164,52,210,209,92,243,107,145,60,128,138,230,228,127,212,145,10,211,191,169,177,101,214,217,207,94,217,153,146,117,187,75,112,121,207,223,254,238,188,167,250,52,195,219,235,224,39,128,36,3,148,128,193,167,246,220,97,111,242,221,161,214,58,59,67,200,0,240,36,168,15,197,73,151,23,170,80,173,47,84,84,195,217,116,249,186,211,176,220,40,37,149,147,109,146,201,0,184,65,143,5,87,184,60,85,93,81,196,248,242,4,99,249,82,232,11,179,197,120,218,1,219,47,123,4,207,217,22,245,53,188,3,133,42,178,189,85,255,171,29,3,91,35,24,66,254,84,49,91,235,153,69,4,110,4,158,186,14,174,196,138,106,93,151,51,183,249,151,101,10,119,226,41,198,54,212,81,36,160,67,128,91,181,52,52,55,244,200,56,246,130,77,26,221,42,109,31,164,199,185,110,30,176,238,124,212,184,5,51,191,14,88,84,120,75,206,95,29,134,62,227,77,250,150,126,126,31,161,162,236,53,102,67,29,236,33,111,110,222,212,98,75,37,233,142,229,113,240,55,39,66,168,11,185,207,180,49,224,244,197,3,99,159,199,252,112,239,177,203,198,43,179,5,203,139,13,38,85,101,91,0,112,9,32,43,44,188,38,11,115,126,30,163,162,124,73,21,174,223,131,72,210,116,253,175,125,186,236,232,186,208,109,74,146,36,72,249,8,114,252,157,57,18,68,248,87,158,77,13,200,186,70,209,139,96,137,133,194,229,94,188,2,59,182,132,40,18,130,108,194,189,1,142,167,165,64,250,21,182,203,84,230,161,86,202,255,136,160,223,175,71,58,5,195,29,176,141,47,24,197,247,122,25,55,25,81,162,208,99,26,104,144,22,178,42,176,113,205,151,221,254,63,208,136,145,49,118,168,233,9,120,86,65,222,75,104,90,249,70,35,225,19,230,162,87,11,57,34,168,56,1,3,223,222,92,231,203,144,41,64,198,23,104,255,53,71,243,15,231,94,78,14,223,43,230,228,89,193,72,81,122,98,113,87,148,174,200,246,184,71,95,2,83,22,73,127,169,0,162,3,194,31,107,6,92,190,221,245,105,40,116,223,133,87,142,29,138,183,194,127,179,11,216,20,25,221,189,209,198,25,116,123,128,165,78,105,189,177,64,148,180,240,251,137,93,187,17,152,84,218,122,143,145,191,146,144,210,209,251,70,160,205,108,74,101,178,64,168,24,44,174,26,169,239,108,158,164,40,159,93,215,174,137,135,124,179,251,196,213,89,48,217,224,208,82,73,27,133,240,126,33,78,249,181,167,97,92,10,223,65,4,222,38,247,238,208,56,193,134,166,247,113,176,218,12,229,4,112,45,199,168,56,108,231,101,164,117,70,233,88,96,247,172,147,251,232,129,61,159,197,10,204,183,44,64,205,134,102,45,184,24,240,154,22,157,162,164,211,154,26,158,181,113,95,137,2,221,119,152,205,222,119,146,51,151,125,197,106,192,175,106,136,141,3,1,200,137,87,17,138,198,232,52,15,179,235,242,52,133,115,95,245,115,133,15,212,193,221,173,120,13,35,117,107,127,119,198,199,34,197,150,34,154,65,36,35,240,241,130,64,167,15,166,76,135,26,146,65,111,196,87,15,214,75,87,139,191,180,213,88,153,198,73,177,112,110,101,80,229,65,8,74,1,37,89,95,130,201,61,36,17,90,14,214,229,102,214,212,38,251,129,13,26,132,237,53,183,90,86,91,216,162,107,214,41,226,14,158,109,170,244,212,71,243,238,45,181,150,203,157,47,43,28,227,45,149,150,84,245,101,56,196,253,233,205,105,97,215,193,199,139,53,110,168,250,97,240,16,23,205,34,221,110,253,216,4,168,40,25,146,164,198,194,82,188,60,86,24,218,129,73,2,236,219,80,34,216,145,245,85,91,134,137,21,0,194,124,215,141,4,117,29,169,161,76,214,171,207,80,242,54,45,18,57,88,43,115,146,30,18,187,174,110,151,179,50,187,143,188,129,180,41,14,188,117,127,68,35,41,3,222,155,85,99,46,241,157,58,47,103,12,31,205,245,185,62,34,69,41,8,222,5,158,123,190,119,31,240,33,170,174,155,201,212,115,20,210,194,8,195,19,234,52,209,56,139,122,161,189,90,247,248,113,58,5,162,45,122,232,93,51,4,114,77,193,171,244,117,222,92,157,230,55,117,7,101,198,182,235,108,95,178,88,102,9,180,201,113,95,152,131,14,237,226,64,182,40,79,214,116,233,20,83,193,6,99,176,239,177,123,73,231,101,27,215,221,61,194,191,110,25,214,188,47,242,71,130,248,170,188,112,157,238,103,40,119,14,226,106,190,167,19,176,205,217,193,217,215,86,102,200,241,100,157,203,121,210,104,77,215,239,207,91,77,62,60,125,131,189,232,231,77,211,195,161,124,110,14,169,42,111,9,46,197,182,88,250,191,122,148,18,74,226,194,36,83,36,196,159,149,211,77,131,26,5,53,74,169,132,200,100,118,5,151,201,59,139,44,84,124,232,184,86,61,31,17,218,23,59,55,68,74,164,217,59,73,219,22,31,112,81,59,10,28,210,123,233,28,210,211,236,215,158,196,2,211,42,13,198,215,163,57,139,206,45,220,76,75,19,243,145,1,195,235,32,237,119,177,96,154,171,95,243,127,171,114,148,251,174,149,181,19,158,115,164,140,205,124,56,244,63,94,146,42,247,12,13,244,177,48,233,243,202,8,57,188,165,97,13,97,180,178,178,29,166,210,54,182,59,60,87,182,11,252,64,188,30,161,83,121,87,143,140,197,88,245,46,75,166,94,15,12,244,155,203,235,173,143,18,76,5,99,51,167,192,128,250,91,162,101,111,77,45,137,168,220,137,112,92,40,57,205,38,131,32,192,198,141,85,137,49,127,27,59,193,125,114,193,235,219,251,102,149,201,11,255,147,181,41,138,186,207,173,16,187,29,68,43,63,8,192,80,119,134,84,180,126,149,14,229,102,123,2,128,144,105,170,99,228,236,83,201,241,203,137,146,62,124,207,100,56,152,233,140,198,250,115,64,234,95,34,223,27,60,166,122,63,20,41,189,22,92,28,239,102,2,141,129,157,158,11,229,32,157,40,87,236,144,88,28,174,45,158,118,248,145,186,156,42,49,104,208,139,164,120,49,244,12,59,222,89,138,10,146,70,83,40,165,136,226,194,53,120,47,138,197,35,209,48,159,110,106,174,183,240,70,234,146,137,153,252,144,28,29,46,9,126,105,177,239,16,36,211,166,133,190,50,98,213,152,192,124,107,171,95,99,223,99,245,247,222,117,111,177,129,165,150,65,37,212,144,199,76,162,240,7,98,37,203,113,128,33,169,59,64,74,165,117,28,41,65,37,31,188,212,142,23,8,12,240,160,38,197,242,253,202,101,226,172,85,128,195,72,186,118,117,37,27,254,118,54,63,73,74,31,114,118,57,70,234,147,28,172,4,102,11,185,188,247,234,255,79,241,96,90,206,47,95,204,182,242,75,75,19,143,45,209,92,203,21,3,27,0,47,240,171,27,56,4,30,121,157,234,111,25,222,195,47,207,229,55,48,183,246,16,83,160,77,165,239,144,228,87,27,97,249,230,181,222,182,90,104,107,41,179,152,126,137,173,172,248,217,175,122,228,182,112,99,57,61,167,138,224,57,145,106,196,5,194,243,98,34,81,134,150,7,77,218,103,212,137,238,169,253,209,239,169,233,74,18,146,45,150,86,197,33,161,38,63,39,9,63,119,125,28,47,84,190,170,238,243,69,207,253,199,42,132,214,51,54,220,189,224,4,50,203,69,115,99,49,242,49,138,80,48,24,33,238,218,230,229,141,212,195,194,100,112,99,70,165,166,209,233,102,133,142,251,226,19,66,248,112,110,10,180,93,107,2,31,175,231,67,95,17,206,58,147,18,49,181,84,42,1,227,95,24,98,207,178,59,216,238,224,191,9,50,126,56,184,252,60,184,5,51,216,210,82,160,128,2,206,170,20,105,140,63,186,26,216,157,137,39,115,166,139,234,23,123,105,102,113,88,252,30,111,242,105,192,248,11,0,164,109,255,222,46,209,207,86,246,101,172,148,92,169,182,251,37,221,203,12,3,214,243,197,195,58,198,2,235,189,206,107,189,210,39,150,245,63,146,133,128,38,104,168,97,54,93,186,105,5,69,248,34,120,51,10,80,117,120,3,53,61,155,192,146,182,116,212,62,46,19,202,84,84,101,132,45,34,31,59,213,135,123,206,207,78,41,160,138,9,137,59,145,218,44,42,246,179,55,68,128,48,179,239,231,159,134,228,49,74,13,192,245,51,209,73,223,167,212,19,74,173,20,46,98,126,72,241,161,151,108,179,41,31,158,40,92,218,173,248,220,67,189,209,70,40,38,42,156,2,10,219,13,5,233,82,233,190,229,41,92,170,0,124,34,217,173,74,183,22,20,168,120,156,163,151,45,75,73,33,103,60,71,221,243,200,178,145,123,215,109,61,36,2,122,186,114,69,242,17,229,137,128,247,98,124,245,102,225,122,46,249,72,182,44,82,249,130,239,75,178,203,189,58,187,167,64,97,69,130,192,49,3,33,64,113,186,172,249,85,248,122,254,134,152,76,248,41,31,228,211,182,69,61,255,219,105,124,113,68,51,63,33,77,131,72,152,82,12,219,15,128,22,211,89,223,230};
uint8_t aReceiveBuffer[RX_BUFFER_SIZE] = {0x00};
uint8_t packetIndex=0;

uint8_t fragmentedTxBuffer[ MAX_PAYLOAD_SIZE ]={0x00};
uint8_t receivedData[Length];
uint8_t Size;
uint8_t flag;
extern SRadioInit xRadioInit;
extern UART_HandleTypeDef huart2;

/* Application defined push button, to detect long push */

/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
/* Global variables ----------------------------------------------------------*/

/* Private functions ---------------------------------------------------------*/
static volatile FlagStatus s_xTIMChCompareModeRaised = RESET;
/**
* @brief  WMBus Link Layer State Enum.
*/
typedef enum {
   SM_STATE_START_RX=0,
   SM_STATE_WAIT_FOR_RX_DONE,
   SM_STATE_DATA_RECEIVED,
   SM_STATE_SEND_DATA,
   SM_STATE_WAIT_FOR_TX_DONE,
   SM_STATE_ACK_RECEIVED,
   SM_STATE_SEND_ACK,
   SM_STATE_TOGGLE_LED,
   SM_STATE_IDLE=0xFF
} SM_State_t;

typedef struct sRadioDriver
{
    void ( *Init )( void );
    void ( *GpioIrq )( SGpioInit *pGpioIRQ );
    void ( *RadioInit )( SRadioInit *pRadioInit );
    void ( *SetRadioPower )( uint8_t cIndex, float fPowerdBm );
    void ( *PacketConfig )( void );
    void ( *SetPayloadLen )( uint8_t length);
    void ( *SetDestinationAddress )( uint8_t address);
    void ( *EnableTxIrq )( void );
    void ( *EnableRxIrq )( void );
    void ( *DisableIrq )(void);
    void ( *SetRxTimeout )( float cRxTimeout );
    void ( *EnableSQI )(void);
    void ( *SetRssiThreshold)(int dbmValue);
    void ( *ClearIrqStatus )(void);
    void ( *StartRx )( void );
    void ( *StartTx )( uint8_t *buffer, uint8_t size );
    void ( *GetRxPacket )( uint8_t *buffer, uint8_t *size );
}RadioDriver_t;

typedef struct sMCULowPowerMode
{
    void ( *McuStopMode )( void );
    void ( *McuStandbyMode )( void );
    void ( *McuSleepMode )( void );
}MCULowPowerMode_t;

typedef struct sRadioLowPowerMode
{
    void ( *RadioShutDown )( void );
    void ( *RadioStandBy )( void );
    void ( *RadioSleep ) ( void );
    void ( *RadioPowerON )( void );
}RadioLowPowerMode_t;

typedef struct
{
  uint8_t Cmdtag;
  uint8_t CmdType;
  uint8_t CmdLen;
  uint8_t Cmd;
  uint8_t DataLen;
  uint8_t* DataBuff;
}AppliFrame_t;
typedef struct {
    uint8_t preamble[8];
    uint8_t flag;
    uint8_t destAddress[7];
    uint8_t ssid;
    uint8_t srcAddress[7];
    uint8_t sssid;
    uint8_t control;
    uint8_t pid;
    uint8_t* informationField;
    uint16_t fcs;
    uint8_t flag2;
    uint8_t postamble[3];
} DataPacket;
#ifdef CSMA_ENABLE
typedef struct
{
  int32_t RxRSSIThreshold;
  uint8_t CsmaEnabled;
  int32_t CsmaRSSIThreshold;/!<RSSI Threshold for CSMA/
  uint8_t CsmaOverrideFail;
  uint8_t CsmaCcaPeriod; /!< RSSI meas cycle = (CsmaCcaPeriod+1)*64*TBIT/
  uint8_t CsmaCcaLength; /*!<times of CsmaCcaPeriod for ch assesment */
  uint8_t CsmaMaxNb; /*!<Max N backoff */
  uint16_t CsmaBuSeed; /!<seed for rand in (2^rand) presc */
  uint8_t CsmaBuPrescaler; /*!<presc for (2^rand)*presc */
}CSMA_Attr_typedef;
#endif

/* Exported functions ------------------------------------------------------- */

void Enter_LP_mode(void);
void Exit_LP_mode(void);
void MCU_Enter_StopMode(void);
void MCU_Enter_StandbyMode(void);
void MCU_Enter_SleepMode(void);
void RadioPowerON(void);
void RadioPowerOFF(void);
void RadioStandBy(void);
void RadioSleep(void);
void AppliSendBuff(AppliFrame_t *xTxFrame, uint8_t cTxlen);
void AppliReceiveBuff(uint8_t *RxFrameBuff, uint8_t cRxlen);
void STackProtocolInit(void);
void BasicProtocolInit(void);
static void P2PInterruptHandler(void);
void Set_KeyStatus(FlagStatus val);
void S2LPInterfaceInit(void);
void S2LP_ManagementSetBand(uint8_t value);
uint8_t S2LP_ManagementGetBand(void);
void S2LP_ManagementSetOffset(int32_t value);
int32_t S2LP_ManagementGetOffset(void);
uint8_t S2LP_ManagementGetTcxo(void);
S2LPCutType S2LP_ManagementGetCut(void);
void S2LP_ManagementRangeExtInit(void);
void S2LP_ManagementSetRangeExtender(RangeExtType xRangeType);
RangeExtType S2LP_ManagementGetRangeExtender(void);
void S2LP_ManagementIdentificationRFBoard(void);
uint32_t S2LP_ManagementComputeXtalFrequency(void);
uint8_t EepromIdentification(void);
void S2LP_ManagementSetTcxo(uint8_t tcxo);
void S2LP_PacketConfig(void);
void S2LP_SetPayloadlength(uint8_t length);
void S2LP_SetDestinationAddress(uint8_t address);
void S2LP_EnableTxIrq(void);
void S2LP_EnableRxIrq(void);
void S2LP_SetRxTimeout(float cRxTimeOut);
void S2LP_EnableSQI(void);
float S2LP_GetRssiTH(void);
void S2LP_StartRx(void);
void S2LP_GetRxPacket(uint8_t *buffer, uint8_t *size );
void S2LP_StartTx(uint8_t *buffer, uint8_t size);
void HAL_SYSTICK_Callback(void);
void MX_SUBG2_P2P_Init(void);
void MX_SUBG2_P2P_Process(uint8_t pTxBuff, uint32_t cTxlen, uint8_t pRxBuff, uint8_t cRxlen);
uint8_t find_packet_size();
static GpioIrqHandler *GpioIrq[] = {

#if (USE_S2868A2_RADIO_GPIO_0 == 1)
  P2PInterruptHandler,
#endif
#if (USE_S2868A2_RADIO_GPIO_1 == 1)
  P2PInterruptHandler,
#endif
#if (USE_S2868A2_RADIO_GPIO_2 == 1)
  P2PInterruptHandler,
#endif
#if (USE_S2868A2_RADIO_GPIO_3 == 1)
  P2PInterruptHandler,
#endif
};

/**
* @brief RadioDriver_t structure fitting
*/

RadioDriver_t radio_cb =
{
  .PacketConfig = RadioPacketConfig,
  .SetPayloadLen = RadioSetPayloadlength,
  .SetDestinationAddress = RadioSetDestinationAddress,
  .EnableTxIrq = RadioEnableTxIrq,
  .EnableRxIrq = RadioEnableRxIrq,
  .SetRxTimeout = RadioSetRxTimeout,
  .EnableSQI = RadioEnableSQI,
  .StartRx = RadioStartRx,
  .StartTx = RadioStartTx,
  .GetRxPacket = RadioGetRxPacket
};

/**
* @brief MCULowPowerMode_t structure fitting
*/
MCULowPowerMode_t MCU_LPM_cb =
{
  .McuStopMode = MCU_Enter_StopMode,
  .McuStandbyMode = MCU_Enter_StandbyMode,
  .McuSleepMode = MCU_Enter_SleepMode
};

/**
* @brief RadioLowPowerMode_t structure fitting
*/
RadioLowPowerMode_t Radio_LPM_cb =
{
  .RadioShutDown = RadioPowerOFF,
  .RadioStandBy = RadioStandBy,
  .RadioSleep = RadioSleep,
  .RadioPowerON = RadioPowerON
};

/**
* @brief GPIO structure fitting
*/
SGpioInit xGpioIRQ={
  S2LP_GPIO_3,
  RADIO_GPIO_MODE_DIGITAL_OUTPUT_LP,
  RADIO_GPIO_DIG_OUT_IRQ

};

/**
* @brief Radio structure fitting
*/
SRadioInit xRadioInit = {

  BASE_FREQUENCY,
  MODULATION_SELECT,
  DATARATE,
  FREQ_DEVIATION,
  BANDWIDTH
};

#if defined(USE_STack_PROTOCOL)
/**
* @brief Packet Basic structure fitting
*/
PktStackInit xStackInit={
  PREAMBLE_LENGTH,
  SYNC_LENGTH,
  SYNC_WORD,
  LENGTH_WIDTH,
  CRC_MODE,
  CONTROL_LENGTH,
  EN_FEC,
  EN_WHITENING
};

/* LLP structure fitting */
PktStackLlpInit xStackLLPInit ={
  EN_AUTOACK,
  EN_PIGGYBACKING,
  MAX_RETRANSMISSIONS
};

/**
* @brief Address structure fitting
*/
PktStackAddressesInit xAddressInit={
  EN_FILT_MY_ADDRESS,
  MY_ADDRESS,
  EN_FILT_MULTICAST_ADDRESS,
  MULTICAST_ADDRESS,
  EN_FILT_BROADCAST_ADDRESS,
  BROADCAST_ADDRESS
};

#elif defined(USE_BASIC_PROTOCOL)

/**
* @brief Packet Basic structure fitting
*/

PktBasicInit xBasicInit={

  PREAMBLE_LENGTH,
  SYNC_LENGTH,
  SYNC_WORD,
  VARIABLE_LENGTH,
  EXTENDED_LENGTH_FIELD,
  CRC_MODE,
  EN_ADDRESS,
  EN_FEC,
  EN_WHITENING
};

/**
* @brief Address structure fitting
*/
PktBasicAddressesInit xAddressInit={
  EN_FILT_MY_ADDRESS,
  MY_ADDRESS,
  EN_FILT_MULTICAST_ADDRESS,
  MULTICAST_ADDRESS,
  EN_FILT_BROADCAST_ADDRESS,
  BROADCAST_ADDRESS
};
#endif

#ifdef CSMA_ENABLE
/**
* @brief CSMA structure fitting
*/
RadioCsmaInit xCsmaInit={

  PERSISTENT_MODE_EN,
  CS_PERIOD,
  CS_TIMEOUT,
  MAX_NB,
  BU_COUNTER_SEED,
  CU_PRESCALER
};
#endif

/* Private define ------------------------------------------------------------*/
#define TIME_UP                                         0x01

/* Private variables ---------------------------------------------------------*/
RadioDriver_t *pRadioDriver;
MCULowPowerMode_t *pMCU_LPM_Comm;
RadioLowPowerMode_t  *pRadio_LPM_Comm;
/Flags declarations/
volatile int MasterFlag = 0;
volatile FlagStatus xRxDoneFlag = RESET, xTxDoneFlag=RESET, cmdFlag=RESET;
volatile FlagStatus xStartRx=RESET, rx_timeout=RESET, exitTime=RESET;
volatile FlagStatus PushButtonStatusWakeup=RESET;
volatile FlagStatus PushButtonStatusData=RESET;
/IRQ status struct declaration/
RadioIrqs xIrqStatus;

__IO uint32_t KEYStatusData = 0x00;
static AppliFrame_t xTxFrame, xRxFrame;
uint8_t TxFrameBuff[MAX_BUFFER_LEN] = {0x00};
uint16_t exitCounter = 0;
uint16_t txCounter = 0;
uint16_t wakeupCounter = 0;
uint16_t dataSendCounter = 0x00;

SM_State_t SM_State = SM_STATE_START_RX;/* The actual state running */


void MX_X_CUBE_SUBG2_Init(void)
{
  /* USER CODE BEGIN SV */

  /* USER CODE END SV */

  /* USER CODE BEGIN S2LP_Library_Init_PreTreatment */

  /* USER CODE END S2LP_Library_Init_PreTreatment */

  /* Initialize the peripherals and the SUBG2 components */
  MX_SUBG2_P2P_Init();

  /* USER CODE BEGIN SV */

  /* USER CODE END SV */

  /* USER CODE BEGIN S2LP_Library_Init_PostTreatment */

  /* USER CODE END S2LP_Library_Init_PostTreatment */
}
/*
 * LM background task
 */
void MX_X_CUBE_SUBG2_Process(void)
{
  /* USER CODE BEGIN S2LP_Library_Process */

  MX_SUBG2_P2P_Process(aTransmitBuffer, TxLength, aReceiveBuffer, RxLength);
  //transmit(aTransmitBuffer, TxLength);
  /* USER CODE END S2LP_Library_Process */
}

  /**
  * @brief  Initialize the EnergyHarvesting Example
  * @retval None
  */

void MX_SUBG2_P2P_Init(void)
{

  /* Initialize USER LED */
  BSP_LED_Init(LED2);

  /* Configure USER Key Button */
  BSP_PB_Init(BUTTON_KEY, BUTTON_MODE_EXTI);

  S2LPInterfaceInit();

   pRadioDriver = &radio_cb;

  /* S2LP IRQ config */
  S2LP_GPIO_Init(&xGpioIRQ);

  /* S2LP Radio config */
  S2LP_RADIO_Init(&xRadioInit);

  /* S2LP Radio set power */
  S2LP_RADIO_SetMaxPALevel(S_DISABLE);

  if(!S2LP_ManagementGetRangeExtender())
  {
    /* if we haven't an external PA, use the library function */
    S2LP_RADIO_SetPALeveldBm(POWER_INDEX,POWER_DBM);
  }
  else
  {
    /* in case we are using the PA board, the S2LPRadioSetPALeveldBm will be not functioning because
    the output power is affected by the amplification of this external component.
    Set the raw register. */
    uint8_t paLevelValue=0x25; /* for example, this value will give 23dBm about */
    S2LP_WriteRegister(PA_POWER8_ADDR, 1, &paLevelValue);
  }
  S2LP_RADIO_SetPALevelMaxIndex(POWER_INDEX);

  /* S2LP Packet config */
  pRadioDriver->PacketConfig();

  pRadioDriver->EnableSQI();

  S2LP_RADIO_QI_SetRssiThreshdBm(RSSI_THRESHOLD);

}
uint8_t  find_packet_size(){
	uint8_t remainder = Length % MAX_PAYLOAD_SIZE;
	uint8_t totalPackets = Length / MAX_PAYLOAD_SIZE;

	if(remainder != 0){
		totalPackets++;
	}
	return totalPackets;
	}

/**
  * @brief  Process of the P2P application
  * @retval None
  */

void MX_SUBG2_P2P_Process(uint8_t pTxBuff, uint32_t cTxlen, uint8_t pRxBuff, uint8_t cRxlen)
{
  uint8_t xIndex = 0;
  uint8_t ledToggleCtr = 0;
  uint8_t  dest_addr;
  /float rRSSIValue = 0;/
  uint8_t totalPackets=find_packet_size();

//  while(packetIndex<totalPackets){
  switch(SM_State)
  {
  case SM_STATE_START_RX:
    {
      AppliReceiveBuff(pRxBuff, cRxlen);
      /* wait for data received or timeout period occured */
      SM_State = SM_STATE_WAIT_FOR_RX_DONE;
    }
    break;

  case SM_STATE_WAIT_FOR_RX_DONE:
  {
    if((RESET != xRxDoneFlag)||(RESET != rx_timeout)||(SET != exitTime))
    {
      if((rx_timeout==SET)||(exitTime==RESET))
      {
        rx_timeout = RESET;
        SM_State = SM_STATE_START_RX;
      }
      else if(xRxDoneFlag)
      {
        xRxDoneFlag=RESET;
        SM_State = SM_STATE_DATA_RECEIVED;
      }
    }
  }
    break;

  case SM_STATE_DATA_RECEIVED:
    {

      pRadioDriver = &radio_cb;

      pRadioDriver->GetRxPacket(pRxBuff,&cRxlen);
      /rRSSIValue = Spirit1GetRssiTH();/
      /rRSSIValue = S2LPGetRssiTH();/
      xRxFrame.Cmd = pRxBuff[0];
      xRxFrame.CmdLen = pRxBuff[1];
      xRxFrame.Cmdtag = pRxBuff[2];
      xRxFrame.CmdType = pRxBuff[3];
      xRxFrame.DataLen = pRxBuff[4];


      for (xIndex = 5; xIndex < cRxlen; xIndex++)
      {
        xTxFrame.DataBuff[xIndex-5] = pRxBuff[xIndex];
      }
       memcpy(receivedData+ packetIndex * MAX_PAYLOAD_SIZE,&pRxBuff[5+27],(pRxBuff[4]-33));
//	  char str[4];  // Allocate buffer for string representation of integers
//	      	     	    memset(str, 0, sizeof(str));  // Clear buffer
//	      	     	    for (int i = 5; i <cRxlen; i++) {
//	      	     	        sprintf(str, "%u ", pRxBuff[i]);  // Convert integer to string and append to buffer
//	      	     	        HAL_UART_Transmit(&huart2, (uint8_t *)str, sizeof(str), HAL_MAX_DELAY);
//
//	      	     	    }
//	      	     	    sprintf(str, "\r\n");
//	      	     	    HAL_UART_Transmit(&huart2, (uint8_t *)str, sizeof(str),1000);

      if(xRxFrame.Cmd == LED_TOGGLE)
      {
         MasterFlag = 0;
        SM_State = SM_STATE_TOGGLE_LED;
      }

      if(xRxFrame.Cmd == ACK_OK)
      {
        SM_State = SM_STATE_ACK_RECEIVED;
      }
    }
    break;

  case SM_STATE_SEND_ACK:
    {
      xTxFrame.Cmd = ACK_OK;
      xTxFrame.CmdLen = 0x01;
      xTxFrame.Cmdtag = xRxFrame.Cmdtag;
      xTxFrame.CmdType = APPLI_CMD;
	  xTxFrame.DataBuff = &pRxBuff[5];
      xTxFrame.DataLen = Size+33;

      HAL_Delay(DELAY_TX_LED_GLOW);
      AppliSendBuff(&xTxFrame, xTxFrame.DataLen);
      SM_State = SM_STATE_WAIT_FOR_TX_DONE;
    }
    break;



  case SM_STATE_SEND_DATA:
    {
    	//memset(fragmentedTxBuffer, 0, sizeof(fragmentedTxBuffer));
    	uint8_t payloadSize = (packetIndex == totalPackets - 1) ? (cTxlen % MAX_PAYLOAD_SIZE) : MAX_PAYLOAD_SIZE;
    	Size=payloadSize;
    	 memcpy(fragmentedTxBuffer, pTxBuff + packetIndex * MAX_PAYLOAD_SIZE, payloadSize);
    	 uint8_t packetSize=payloadSize+33;
    	 	 uint8_t packet [packetSize];
    	 	 encodeDataIntoPacket(fragmentedTxBuffer,Size,packet);
//    	 char str[4];  // Allocate buffer for string representation of integers
//    		      	     	    memset(str, 0, sizeof(str));  // Clear buffer
//    		      	     	    for (int i = 0; i <Size; i++) {
//    		      	     	        sprintf(str, "%u ", fragmentedTxBuffer[i]);  // Convert integer to string and append to buffer
//    		      	     	        HAL_UART_Transmit(&huart2, (uint8_t *)str, sizeof(str), HAL_MAX_DELAY);
//
//    		      	     	    }
//    		      	     	    sprintf(str, "\r\n");
//    		      	     	    HAL_UART_Transmit(&huart2, (uint8_t *)str, sizeof(str),1000);

      xTxFrame.Cmd = LED_TOGGLE;
      xTxFrame.CmdLen = 0x01;
      xTxFrame.Cmdtag = txCounter++;
      xTxFrame.CmdType = APPLI_CMD;
//      xTxFrame.DataBuff = pTxBuff;
//      xTxFrame.DataLen = cTxlen;
      xTxFrame.DataLen = packetSize;
     // xTxFrame.DataBuff = fragmentedTxBuffer;
      xTxFrame.DataBuff = packet;
      AppliSendBuff(&xTxFrame, xTxFrame.DataLen);
      SM_State = SM_STATE_WAIT_FOR_TX_DONE;
    }
    break;

  case SM_STATE_WAIT_FOR_TX_DONE:
    /* wait for TX done */
    if(xTxDoneFlag)
    {
    	if(packetIndex<totalPackets){
    		packetIndex=packetIndex+1;
    	//i=i-1;}
    	    }
    	char str[4];  // Allocate buffer for string representation of integers
    	    		      	     	    memset(str, 0, sizeof(str));  // Clear buffer
    	    		      	     	    for (int i = 0; i <Size; i++) {
    	    		      	     	        sprintf(str, "%u ", fragmentedTxBuffer[i]);  // Convert integer to string and append to buffer
    	    		      	     	        HAL_UART_Transmit(&huart2, (uint8_t *)str, sizeof(str), HAL_MAX_DELAY);

    	    		      	     	    }
    	    		      	     	    sprintf(str, "\r\n");
    	    		      	     	    HAL_UART_Transmit(&huart2, (uint8_t *)str, sizeof(str),1000);


      xTxDoneFlag = RESET;

      if(xTxFrame.Cmd == LED_TOGGLE)
      {
        SM_State = SM_STATE_START_RX;
      }
      else if(xTxFrame.Cmd == ACK_OK  )
      {
         if(packetIndex==totalPackets){
    		 char tr[4];  // Allocate buffer for string representation of integers
    		    	    	      	     	    memset(tr, 0, sizeof(tr));  // Clear buffer
    		    	    	      	     	    for (int i = 0; i <Length; i++) {
    		    	    	      	     	        sprintf(tr, "%u, ", receivedData[i] );  // Convert integer to string and append to buffer

    		                                       HAL_UART_Transmit(&huart2, (uint8_t *)tr, sizeof(tr), HAL_MAX_DELAY);

    		    	    	      	     	    }
    		    	    	      	     	    sprintf(tr, "\r\n");
    		    	    	      	     	    HAL_UART_Transmit(&huart2, (uint8_t *)tr, sizeof(tr),1000);}

        SM_State = SM_STATE_IDLE;
      }
    }
    break;

  case SM_STATE_ACK_RECEIVED:
   if (MasterFlag == 1)
   {
    for(; ledToggleCtr<4; ledToggleCtr++)
    {
      BSP_LED_Toggle(LED2);

      HAL_Delay(DELAY_RX_LED_TOGGLE);
    }

   }
   if(packetIndex!=totalPackets){
	  // HAL_Delay(100);
	   SM_State = SM_STATE_SEND_DATA;
   }
   else {
	   SM_State = SM_STATE_IDLE;
	   packetIndex=0;

   }

    break;

  case SM_STATE_TOGGLE_LED:

    BSP_LED_On(LED2);
    dest_addr = RadioGetReceivedDestinationAddress();

    if ((dest_addr == MULTICAST_ADDRESS) || (dest_addr == BROADCAST_ADDRESS))
    {
      /* in that case do not send ACK to avoid RF collisions between several RF ACK messages */
      HAL_Delay(DELAY_TX_LED_GLOW);
      SM_State = SM_STATE_IDLE;
    }
    else
    {
      SM_State = SM_STATE_SEND_ACK;
    }
    break;

  case SM_STATE_IDLE:

    BSP_LED_Off(LED2);
    SM_State = SM_STATE_START_RX;

#if defined(USE_LOW_POWER_MODE)
    Enter_LP_mode();
#endif
    break;
}

  }

/**
* @brief  This function handles the point-to-point packet transmission
* @param  AppliFrame_t *xTxFrame = Pointer to AppliFrame_t structure
*         uint8_t cTxlen = Length of aTransmitBuffer
* @retval None
*/
void AppliSendBuff(AppliFrame_t *xTxFrame, uint8_t cTxlen)
{
  uint8_t xIndex = 0;
  uint8_t trxLength = 0;
  pRadioDriver = &radio_cb;

#ifdef USE_STack_PROTOCOL

  PktStackAddressesInit xAddressInit=
  {
    .xFilterOnMyAddress = S_ENABLE,
    .cMyAddress = MY_ADDRESS,
    .xFilterOnMulticastAddress = S_DISABLE,
    .cMulticastAddress = MULTICAST_ADDRESS,
    .xFilterOnBroadcastAddress = S_ENABLE,
    .cBroadcastAddress = BROADCAST_ADDRESS
  };
  S2LP_PCKT_STACK_AddressesInit(&xAddressInit);

#ifdef USE_STack_LLP

  /* LLP structure fitting */
  PktStackLlpInit xStackLLPInit=
  {
    .xAutoAck = S_DISABLE,
    .xPiggybacking = S_DISABLE,
    .xNMaxRetx = PKT_N_RETX_2
  };

#else

  /* LLP structure fitting */
  PktStackLlpInit xStackLLPInit=
  {
    .xAutoAck = S_DISABLE,
    .xPiggybacking = S_DISABLE,
    .xNMaxRetx = PKT_DISABLE_RETX
  };
#endif

  Radio_PktStackLlpInit(&xStackLLPInit);

#endif

#ifdef USE_BASIC_PROTOCOL
  S2LP_PCKT_BASIC_AddressesInit(&xAddressInit);
#endif

  TxFrameBuff[0] = xTxFrame->Cmd;
  TxFrameBuff[1] = xTxFrame->CmdLen;
  TxFrameBuff[2] = xTxFrame->Cmdtag;
  TxFrameBuff[3] = xTxFrame->CmdType;
  TxFrameBuff[4] = xTxFrame->DataLen;

  for(; xIndex < xTxFrame->DataLen; xIndex++)
  {
    TxFrameBuff[xIndex+5] =  xTxFrame->DataBuff[xIndex];
  }

  trxLength = (xIndex+5);

  S2LP_GPIO_IrqDeInit(NULL);

  pRadioDriver->EnableTxIrq();
  /* payload length config */
  pRadioDriver->SetPayloadLen(trxLength);
  /* rx timeout config */
  pRadioDriver->SetRxTimeout(RECEIVE_TIMEOUT);
  /* IRQ registers blanking */

  S2LP_GPIO_IrqClearStatus();
  /* destination address */
  pRadioDriver->SetDestinationAddress(DESTINATION_ADDRESS);

  /* send the TX command */
  pRadioDriver->StartTx(TxFrameBuff, trxLength);
}

/**
* @brief  This function handles the point-to-point packet reception
* @param  uint8_t *RxFrameBuff = Pointer to ReceiveBuffer
*         uint8_t cRxlen = length of ReceiveBuffer
* @retval None
*/
void AppliReceiveBuff(uint8_t *RxFrameBuff, uint8_t cRxlen)
{
  /float rRSSIValue = 0;/
  exitTime = SET;
  exitCounter = TIME_TO_EXIT_RX;

#ifdef USE_STack_PROTOCOL

#ifdef USE_STack_LLP
  /* LLP structure fitting */
  PktStackLlpInit xStackLLPInit=
  {
    .xAutoAck = S_ENABLE,
    .xPiggybacking = S_ENABLE,
    .xNMaxRetx = PKT_DISABLE_RETX
  };
#else
  /* LLP structure fitting */
  PktStackLlpInit xStackLLPInit=
  {
    .xAutoAck = S_DISABLE,
    .xPiggybacking = S_DISABLE,
    .xNMaxRetx = PKT_DISABLE_RETX
  };
#endif

  Radio_PktStackLlpInit(&xStackLLPInit);

  PktStackAddressesInit xAddressInit=
  {
    .xFilterOnMyAddress = S_ENABLE,
    .cMyAddress = MY_ADDRESS,
    .xFilterOnMulticastAddress = S_DISABLE,
    .cMulticastAddress = MULTICAST_ADDRESS,
    .xFilterOnBroadcastAddress = S_ENABLE,
    .cBroadcastAddress = BROADCAST_ADDRESS
  };

  S2LP_PCKT_STACK_AddressesInit(&xAddressInit);

  if(EN_FILT_SOURCE_ADDRESS)
  {
    Radio_PktStackFilterOnSourceAddress(S_ENABLE);
    Radio_PktStackSetRxSourceMask(SOURCE_ADDR_MASK);
    Radio_PktStackSetSourceReferenceAddress (SOURCE_ADDR_REF);

  }
  else
  {
    RadioPktStackFilterOnSourceAddress(S_DISABLE);
  }
#endif

  //RadioPktBasicAddressesInit(&xAddressInit);
  S2LP_PCKT_BASIC_AddressesInit(&xAddressInit);

  pRadioDriver = &radio_cb;
  /* S2LP IRQs disable */
  S2LP_GPIO_IrqDeInit(NULL);
  /* S2LP IRQs enable */

  pRadioDriver->EnableRxIrq();
  /* payload length config */
  pRadioDriver->SetPayloadLen(PAYLOAD_LEN);
  /* rx timeout config */

  S2LP_TIM_SetRxTimerMs(700.0);
  SET_INFINITE_RX_TIMEOUT();

  pRadioDriver->SetDestinationAddress(DESTINATION_ADDRESS);
  /* IRQ registers blanking */
  S2LP_GPIO_IrqClearStatus();

  /* RX command */
  pRadioDriver->StartRx();
  /* destination address */
}

/**
* @brief  This function initializes the STack Packet handler of S2LP
* @param  None
* @retval None
*/
void STackProtocolInit(void)
{

  PktStackInit xStackInit=
  {
    .xPreambleLength = PREAMBLE_LENGTH,
    .xSyncLength = SYNC_LENGTH,
    .lSyncWords = SYNC_WORD,

    .xFixVarLength = S_ENABLE,
    .cExtendedPktLenField = S_DISABLE,

    .xCrcMode = CRC_MODE,
    .xFec = EN_FEC,
    .xDataWhitening = EN_WHITENING
  };
  /* Radio Packet config */
  S2LP_PCKT_STACK_Init(&xStackInit);
}

/*xDataWhitening;  *
* @brief  This function initializes the BASIC Packet handler of S2LP
* @param  None
* @retval None
*/
void BasicProtocolInit(void)
{
  /* RAdio Packet config */
 S2LP_PCKT_BASIC_Init(&xBasicInit);
}

/**
* @brief  This routine will put the radio and mcu in LPM
* @param  None
* @retval None
*/
void Enter_LP_mode(void)
{
  pMCU_LPM_Comm = &MCU_LPM_cb;
  pRadio_LPM_Comm = &Radio_LPM_cb;

#if defined(MCU_SLEEP_MODE)&&defined(RF_SHUTDOWN)
  {
    pRadio_LPM_Comm->RadioShutDown();
    pMCU_LPM_Comm->McuSleepMode();
  }
#elif defined(MCU_SLEEP_MODE)&&defined(RF_STANDBY)
  {
    pRadio_LPM_Comm->RadioStandBy();
    pMCU_LPM_Comm->McuSleepMode();
  }
#elif defined(MCU_SLEEP_MODE)&&defined(RF_SLEEP)
  {
    pRadio_LPM_Comm->RadioSleep();
    pMCU_LPM_Comm->McuSleepMode();
  }
#elif defined(MCU_STOP_MODE)&&defined(RF_SHUTDOWN)
  {
    pRadio_LPM_Comm->RadioShutDown();
    pMCU_LPM_Comm->McuStopMode();
  }
#elif defined(MCU_STOP_MODE)&&defined(RF_STANDBY)
  {
    pRadio_LPM_Comm->RadioStandBy();
    pMCU_LPM_Comm->McuStopMode();
  }
#elif defined(MCU_STOP_MODE)&&defined(RF_SLEEP)
  {
    pRadio_LPM_Comm->RadioSleep();
    pMCU_LPM_Comm->McuStopMode();
  }
#else
  pMCU_LPM_Comm->McuSleepMode();
#endif
}

/**
* @brief  This routine wake-up the mcu and radio from LPM
* @param  None
* @retval None
*/
void Exit_LP_mode(void)
{
  pRadio_LPM_Comm = &Radio_LPM_cb;
  pRadio_LPM_Comm->RadioPowerON();
}

/**
* @brief  This routine puts the MCU in stop mode
* @param  None
* @retval None
*/
void MCU_Enter_StopMode(void)
{

  /## Enter Stop Mode #######################################################/
  HAL_PWR_EnterSTOPMode(PWR_LOWPOWERREGULATOR_ON, PWR_STOPENTRY_WFI);

}

/**
* @brief  This routine puts the MCU in standby mode
* @param  None
* @retval None
*/
void MCU_Enter_StandbyMode(void)
{
    /## Enter Standby Mode ####################################################/
  /* Request to enter STANDBY mode  */
  HAL_PWR_EnterSTANDBYMode();
}

/**
* @brief  This routine puts the MCU in sleep mode
* @param  None
* @retval None
*/
void MCU_Enter_SleepMode(void)
{
  /*Suspend Tick increment to prevent wakeup by Systick interrupt.
  Otherwise the Systick interrupt will wake up the device within 1ms (HAL time base)*/

    /* Configure Key Button */
  BSP_PB_Init(BUTTON_KEY, BUTTON_MODE_EXTI);

  /* Suspend Tick increment to prevent wakeup by Systick interrupt.
  Otherwise the Systick interrupt will wake up the device within 1ms (HAL time base) */
  HAL_SuspendTick();

  /* Request to enter SLEEP mode */
  HAL_PWR_EnterSLEEPMode(PWR_MAINREGULATOR_ON, PWR_SLEEPENTRY_WFI);
}

/**
* @brief  This function will turn on the radio and waits till it enters the Ready state.
* @param  Param:None.
* @retval None
*
*/
void RadioPowerON(void)
{

  S2LP_CMD_StrobeReady();

  do{
    /* Delay for state transition */
    for(volatile uint8_t i=0; i!=0xFF; i++);

    /* Reads the MC_STATUS register */

    S2LP_RefreshStatus();

  }
  while(g_xStatus.MC_STATE!=MC_STATE_READY);
}

/**
* @brief  This function will Shut Down the radio.
* @param  Param:None.
* @retval None
*
*/
void RadioPowerOFF(void)
{
  S2868A2_RADIO_EnterShutdown();
}

/**
* @brief  This function will put the radio in standby state.
* @param  None.
* @retval None
*
*/
void RadioStandBy(void)
{
  S2LP_CMD_StrobeStandby();
}

/**
* @brief  This function will put the radio in sleep state.
* @param  None.
* @retval None
*
*/
void RadioSleep(void)
{
  S2LP_CMD_StrobeSleep();
}

/**
* @brief  This routine updates the respective status for key press.
* @param  None
* @retval None
*/
void Set_KeyStatus(FlagStatus val)
{
  if(val==SET)
  {
    SM_State = SM_STATE_SEND_DATA;
    MasterFlag = 1;
  }
  else
    MasterFlag = 0;
}

/**
* @brief  This function handles External interrupt request. In this application it is used
*         to manage the S2LP IRQ configured to be notified on the S2LP GPIO_3.
* @param  None
* @retval None
*/
static void P2PInterruptHandler(void)
{
  S2LP_GPIO_IrqGetStatus(&xIrqStatus);

  /* Check the S2LP TX_DATA_SENT IRQ flag */
  if(
     (xIrqStatus.IRQ_TX_DATA_SENT)

#ifdef CSMA_ENABLE
       ||(xIrqStatus.IRQ_MAX_BO_CCA_REACH)
#endif
         )
  {
#ifdef CSMA_ENABLE
    S2LP_CSMA_Enable(S_DISABLE);
    S2LP_PCKT_HNDL_SetRxPersistentMode(S_ENABLE);
    S2LP_RADIO_QI_CsBlanking(S_ENABLE);

    if(xIrqStatus.IRQ_MAX_BO_CCA_REACH)
    {
      S2LP_CMD_StrobeSabort();
    }
    S2LP_RADIO_QI_SetRssiThreshdBm(RSSI_THRESHOLD);

#endif

    xTxDoneFlag = SET;
  }

  /* Check the S2LP RX_DATA_READY IRQ flag */
  if((xIrqStatus.IRQ_RX_DATA_READY))
  {
    xRxDoneFlag = SET;
  }

  /* Restart receive after receive timeout*/
  if (xIrqStatus.IRQ_RX_TIMEOUT)
  {
    rx_timeout = SET;
    S2LP_CMD_StrobeRx();
  }

  /* Check the S2LP RX_DATA_DISC IRQ flag */
  if(xIrqStatus.IRQ_RX_DATA_DISC)
  {
    /* RX command - to ensure the device will be ready for the next reception */
    S2LP_CMD_StrobeRx();
  }
}

/**
  * @brief  BSP Push Button callback
  * @param  Button Specifies the pin connected EXTI line
  * @retval None.
  */
void BSP_PB_Callback(Button_TypeDef Button)
{
 if(Button==BUTTON_USER)
  {
   Set_KeyStatus(SET);
  }
  else
    Set_KeyStatus(RESET);
}

/**
* @brief  Read the status register.
* @param  None
* @retval Status
*/
void S2LPInterfaceInit(void)
{
  /* Initialize the SDN pin micro side */
  S2868A2_RADIO_Init();

  if( S2LP_Init() != S2LP_OK)
   {
    /* Initialization Error */
     while(1){};
   }

  /* EepromSpiInitialization(); */
  S2868A2_EEPROM_Init(EEPROM_INSTANCE);

  /* S2LP ON */
  S2868A2_RADIO_EnterShutdown();
  S2868A2_RADIO_ExitShutdown();

  S2LP_ManagementIdentificationRFBoard();

  /* if the board has eeprom, we can compensate the offset calling S2LP_ManagementGetOffset
  (if eeprom is not present this fcn will return 0) */
  xRadioInit.lFrequencyBase = (uint32_t) BASE_FREQUENCY + S2LP_ManagementGetOffset();

  /* if needed this will set the range extender pins */
  S2LP_ManagementRangeExtInit();

#if 0
  /* if needed this will set the EXT_REF bit of the S2-LP */

  S2LP_TCXOInit();
#endif

  /* uC IRQ enable */
  S2868A2_RADIO_IoIrqEnable(GpioIrq);
}

/**
* @brief  this function sets the packet configuration according to the protocol used
* @param  None
* @retval None
*/
void S2LP_PacketConfig(void)
{
#if defined(USE_STack_PROTOCOL)

  STackProtocolInit();

#elif defined(USE_BASIC_PROTOCOL)

  BasicProtocolInit();

#endif
}

/**
* @brief  this function sets the payload length
* @param  uint8_t length
* @retval None
*/
void S2LP_SetPayloadlength(uint8_t length)
{
#if defined(USE_STack_PROTOCOL)
  /* Payload length config */
  S2LP_PCKT_STACK_SetPayloadLength(length);

#elif defined(USE_BASIC_PROTOCOL)
  /* payload length config */
  S2LP_PCKT_BASIC_SetPayloadLength(length);
#endif
}

/**
* @brief  this function sets the destination address
* @param  uint8_t adress
* @retval None
*/
void S2LP_SetDestinationAddress(uint8_t address)
{
#if defined(USE_STack_PROTOCOL)
  /* Destination address */
  S2LP_PktStackSetDestinationAddress(address);
#elif defined(USE_BASIC_PROTOCOL)
  /* destination address */
  S2LP_PCKT_HNDL_SetRxSourceReferenceAddress(address);
#endif
}

/**
* @brief  this function enables the Tx IRQ
* @param  None
* @retval None
*/
void S2LP_EnableTxIrq(void)
{
  /* S2LP IRQs enable */
  S2LP_GPIO_IrqConfig(TX_DATA_SENT, S_ENABLE);
#if defined(USE_STack_LLP)
  S2LP_GPIO_IrqConfig(MAX_RE_TX_REACH, S_ENABLE);
#endif
}

/**
* @brief  this function enables the Rx IRQ
* @param  None
* @retval None
*/
void S2LP_EnableRxIrq(void)
{
  /* S2LP IRQs enable */
  S2LP_GPIO_IrqConfig(RX_DATA_READY, S_ENABLE);
  S2LP_GPIO_IrqConfig(RX_DATA_DISC, S_ENABLE);
  S2LP_GPIO_IrqConfig(RX_TIMEOUT, S_ENABLE);
}

/**
* @brief  this function set the receive timeout period
* @param  None
* @retval None
*/
void S2LP_SetRxTimeout(float cRxTimeOut)
{
  if(cRxTimeOut == 0)
  {
    /* rx timeout config */
    SET_INFINITE_RX_TIMEOUT();
    S2LP_TIM_SetRxTimerStopCondition(ANY_ABOVE_THRESHOLD);
  }
  else
  {
    /* RX timeout config */
    S2LP_TIM_SetRxTimerMs(cRxTimeOut);
    S2LP_EnableSQI();
    S2LP_TIM_SetRxTimerStopCondition(RSSI_AND_SQI_ABOVE_THRESHOLD);
  }
}

/**
* @brief  this function enables SQI check
* @param  None
* @retval None
*/
void S2LP_EnableSQI(void)
{
  /* enable SQI check */
  S2LP_RADIO_QI_SetSQIThreshold(0x00);
  S2LP_RADIO_QI_EnableSQI(S_ENABLE);
}
/**
* @brief  this function sets the RSSI threshold
* @param  int dbmValue
* @retval None
*/
float S2LP_GetRssiTH(void)
{
  float dbmValue=0;
  dbmValue = S2LP_RADIO_QI_GetRssidBm();
  return dbmValue;
}

/**
* @brief  this function starts the RX process
* @param  None
* @retval None
*/
void S2LP_StartRx(void)
{
  if(g_xStatus.MC_STATE==MC_STATE_RX)
  {
    S2LP_CMD_StrobeSabort();
  }
  /* RX command */
  S2LP_CMD_StrobeRx();
}

/**
* @brief  this function receives the data
* @param  None
* @retval None
*/
void S2LP_GetRxPacket(uint8_t *buffer, uint8_t *cRxData )
{
  uint8_t noofbytes = 0;
  /* when rx data ready read the number of received bytes */
  *cRxData=S2LP_FIFO_ReadNumberBytesRxFifo();
  noofbytes = *cRxData;
  /* read the RX FIFO */
  S2LP_ReadFIFO(noofbytes, buffer);

  S2LP_CMD_StrobeFlushRxFifo();
}

/**
* @brief  this function starts the TX process
* @param  None
* @retval None
*/
void S2LP_StartTx(uint8_t *buffer, uint8_t size)
{
  if (g_xStatus.MC_STATE == MC_STATE_RX)
  {
    S2LP_CMD_StrobeSabort();
  }

#ifdef CSMA_ENABLE

  /* Enable CSMA */
  S2LP_PCKT_HNDL_SetRxPersistentMode(S_DISABLE);
  S2LP_RADIO_QI_CsBlanking(S_DISABLE);

  S2LP_CSMA_Init(&xCsmaInit);
  S2LP_CSMA_Enable(S_ENABLE);
  S2LP_RADIO_QI_SetRssiThreshdBm(CSMA_RSSI_THRESHOLD);

#endif

  /* fit the TX FIFO */
  S2LP_CMD_StrobeFlushTxFifo();

  S2LP_WriteFIFO(size, buffer);

  /* send the TX command */
  S2LP_CMD_StrobeTx();
}


#ifdef __cplusplus
}
#endif
 uint16_t calculateCRC16CCITT(uint8_t *data, uint8_t length) {
     uint16_t crc = 0xFFFF;

     for (uint8_t i = 0; i < length; i++) {
         crc ^= (uint16_t)data[i] << 8;

         for (uint8_t bit = 0; bit < 8; bit++) {
             if (crc & 0x8000)
                 crc = (crc << 1) ^ CRC16_POLYNOMIAL;
             else
                 crc <<= 1;
         }
     }

     return crc;
 }

 void encodeDataIntoPacket(uint8_t* data, uint8_t dataLength, uint8_t* packet){
 	uint8_t informationFieldSize = dataLength;
 	uint8_t packetSize = 8 + 1 + 7 + 1 + 7 + 1 + 1 + 1 + informationFieldSize + 2 + 1 + 3;
 	DataPacket encodedPacket;
 	    memcpy(encodedPacket.preamble, "\xAA\xAA\xAA\xAA\xAA\xAA\xAA\xAA", 8);
 	    encodedPacket.flag = 0x55;
 	    memcpy(encodedPacket.destAddress, "\x01\x02\x03\x04\x05\x06\x07", 7);
 	    encodedPacket.ssid = 0x08;
 	    memcpy(encodedPacket.srcAddress, "\x09\x0A\x0B\x0C\x0D\x0E\x0F", 7);
 	    encodedPacket.sssid = 0x10;
 	    encodedPacket.control = 0x11;
 	    encodedPacket.pid = 0x12;
 	    encodedPacket.informationField =(uint8_t*)malloc(informationFieldSize);
 	    memcpy(encodedPacket.informationField, data, informationFieldSize);
 	    encodedPacket.fcs = calculateCRC16CCITT(( uint8_t*)&encodedPacket, packetSize - sizeof(encodedPacket.fcs));

 	    encodedPacket.flag2 = 0x16;
 	    memcpy(encodedPacket.postamble, "\xBB\xBB\xBB", 3);
 	    memcpy(packet, encodedPacket.preamble, 8);
 	       packet[8] = encodedPacket.flag;
 	       memcpy(packet + 9, encodedPacket.destAddress, 7);
 	       packet[16] = encodedPacket.ssid;
 	       memcpy(packet + 17, encodedPacket.srcAddress, 7);
 	       packet[24] = encodedPacket.sssid;
 	       packet[25] = encodedPacket.control;
 	       packet[26] = encodedPacket.pid;
 	       memcpy(packet + 27, encodedPacket.informationField, informationFieldSize);
 	       packet[27 + informationFieldSize] = encodedPacket.fcs >> 8;   // Higher byte of FCS
 	       packet[28 + informationFieldSize] = encodedPacket.fcs & 0xFF; // Lower byte of FCS
 	       packet[29 + informationFieldSize] = encodedPacket.flag2;
 	       memcpy(packet + 30 + informationFieldSize, encodedPacket.postamble, 3);

 	       free(encodedPacket.informationField);
 	       }
